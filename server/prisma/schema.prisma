// Prisma Schema for Smart Classroom - Multi-tenant Architecture
// Each university is isolated with separate data spaces

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// University Model (Tenant)
model University {
  id               String   @id @default(cuid())
  name             String   @unique
  contactEmail     String
  contactPhone     String?
  subscriptionType String   @default("trial") // trial, basic, premium, enterprise
  maxUsers         Int      @default(1000)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations - Each university has isolated data
  teachers Teacher[]
  students Student[]
  classes  Class[]
  admins   Admin[]

  @@index([name])
  @@index([isActive])
}

// Admin Model (University Admins)
model Admin {
  id                 String   @id @default(cuid())
  name               String
  registrationNumber String   @unique
  email              String   @unique
  password           String
  universityId       String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  university University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@index([universityId])
  @@index([registrationNumber])
}

// Teacher Model
model Teacher {
  id                 String   @id @default(cuid())
  name               String
  employeeId         String   @unique
  registrationNumber String   @unique
  email              String
  password           String
  department         String
  phone              String?
  isActive           Boolean  @default(true)
  universityId       String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  university University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  classes    Class[]
  minutes    Minute[]

  @@unique([employeeId, universityId])
  @@index([universityId])
  @@index([employeeId])
  @@index([registrationNumber])
  @@index([isActive])
}

// Student Model
model Student {
  id                 String   @id @default(cuid())
  name               String
  registrationNumber String   @unique
  email              String
  password           String
  department         String
  semester           String?
  phone              String?
  isActive           Boolean  @default(true)
  universityId       String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  university   University     @relation(fields: [universityId], references: [id], onDelete: Cascade)
  enrollments  Enrollment[]
  joinRequests JoinRequest[]
  minutes      Minute[]

  @@unique([registrationNumber, universityId])
  @@index([universityId])
  @@index([registrationNumber])
  @@index([isActive])
}

// Class Model
model Class {
  id           String   @id @default(cuid())
  name         String
  subject      String
  code         String
  schedule     Json? // { day: 'Monday', time: '10:00 AM', duration: '1 hour' }
  isActive     Boolean  @default(true)
  teacherId    String
  universityId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  university   University    @relation(fields: [universityId], references: [id], onDelete: Cascade)
  teacher      Teacher       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  enrollments  Enrollment[]
  joinRequests JoinRequest[]
  minutes      Minute[]

  @@unique([code, universityId])
  @@index([universityId])
  @@index([teacherId])
  @@index([isActive])
  @@index([code])
}

// Enrollment Model (Student-Class relationship)
model Enrollment {
  id        String   @id @default(cuid())
  studentId String
  classId   String
  status    String   @default("active") // active, dropped, completed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
  @@index([status])
}

// Join Request Model
model JoinRequest {
  id        String   @id @default(cuid())
  studentId String
  classId   String
  status    String   @default("pending") // pending, approved, rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
  @@index([status])
}

// Minute Model (Class attendance/minutes)
model Minute {
  id          String   @id @default(cuid())
  classId     String
  studentId   String
  teacherId   String
  date        DateTime
  duration    Int // in minutes
  topic       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([studentId])
  @@index([teacherId])
  @@index([date])
}
